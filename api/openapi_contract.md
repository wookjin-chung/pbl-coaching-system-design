# OpenAPI Contract  
## PBL 코칭 서비스의 API 행동 계약(설계 기준)

---

## 이 문서의 목적

이 문서는 PBL 코칭 서비스에서 API(OpenAPI)가 무엇을 의미하는지,  
그리고 **어떤 원칙을 반드시 지켜야 하는지**를 정의합니다.

이 시스템에서 API는 단순히 “데이터를 주고받는 인터페이스”가 아닙니다.

> API는 **행동 계약(Behavioral Contract)** 입니다.  
> 즉, 사용자의 기록·자각·정리 흐름이 끊기지 않도록 보장하는  
> 서비스의 **약속**입니다.

이 문서는:
- 실제 OpenAPI YAML 스펙 작성의 상위 기준이며
- 프론트/백엔드가 공유하는 계약의 “헌법” 역할을 합니다.

---

## 기본 전제: 이 시스템에서 API가 지켜야 할 것

### 1️⃣ API는 사용자의 판단을 대신하지 않는다

API는:
- 점수나 등급으로 사용자를 평가하지 않으며
- “다음 단계”를 확정하여 내려주지 않고
- 결론형 판단을 반환하지 않습니다.

API는 사용자의 흐름을 위한:
- 기록의 저장
- 정리의 재현
- 경로의 복원
- 모드의 제안

만을 수행합니다.

---

### 2️⃣ API는 숫자보다 ‘신호’를 우선한다

이 시스템은 초기 MVP 단계에서 특히  
정량 지표보다 **신호(signal)** 를 우선합니다.

- “정확히 몇 명”보다
- “관계가 형성되고 있는지”를 먼저 본다

따라서 API 응답은:
- 정확한 숫자 강제보다
- **상태/방향/존재 여부** 중심으로 설계됩니다.

---

### 3️⃣ API는 ‘현재 문맥’을 중심으로 설계한다

각 API 응답은:
- 사용자의 현재 상태(UI state)
- 현재 단계(PBL stage)
- 현재 렌즈(코칭 모드)
- 현재 시간 축(과거/현재/미래)

을 직접적으로 “판정”하지 않더라도,  
그 문맥을 **지속**시키도록 설계되어야 합니다.

---

## 계약 범위(Contract Scope)

OpenAPI 계약은 다음 범위를 포함합니다.

### ✅ 포함
- 기록 생성/수정/조회
- 세션/프로젝트 단위의 경로 요약 제공
- AI 응답 생성(질문/정리/렌즈 제안)
- Path Awareness(과거 카드/현재 상태/미래 씨앗) 노출에 필요한 최소 데이터
- 관리자용 신호 대시보드(관계 신호, 재개 신호, 기록 흐름)

### ❌ 제외(초기)
- 결제/구독/과금 API
- 사용자 등급/점수/평점 API
- 개인별 인간 코치 개입 API
- 추천의 강제 집행(“이 모드로 이동”) API

---

## 엔드포인트 설계 원칙

### 1️⃣ 최소 엔드포인트, 최대 일관성

MVP에서는 엔드포인트 수를 늘리지 않습니다.  
대신, **응답 형태를 안정화**합니다.

- 자주 바뀌는 세부 필드는 `meta` 또는 `experimental`로 격리
- 안정 필드는 `data`에 유지

---

### 2️⃣ 요청은 “행동” 중심, 응답은 “다음 질문” 중심

요청은:
- 사용자가 무엇을 입력했는지(행동)
- 어떤 기록을 남겼는지(기록)

중심으로 설계합니다.

응답은:
- 무엇이 정답인지가 아니라
- 다음에 스스로 생각할 수 있는 **질문**을 반환합니다.

---

### 3️⃣ AI 응답은 반드시 ‘렌즈’와 ‘시간 축’을 가진다

AI 응답은 자유 텍스트만 반환하지 않습니다.

반드시 다음 메타를 포함합니다.

- `mode`: 코칭 모드(렌즈)
- `time_axis`: 과거/현재/미래 중 하나
- `intent`: 요약/질문/정리/관점제안 중 하나(또는 복합)

이는 AI가 판단을 대신하지 않도록  
시스템이 **스스로를 제어하는 장치**입니다.

---

### 4️⃣ “정체성 반영형”은 출력이 아니라 질문만 반환한다

정체성 반영형 모드가 열리더라도  
API는 결론형 패턴을 반환하지 않습니다.

- “당신은 이런 사람이다” 금지
- “당신은 이런 습관이 있다” 금지

허용되는 것은:
- “최근 기록에서 이런 질문이 떠오를 수 있다” 형태의 질문

이 규칙은:
- 프롬프트 수준이 아니라
- API 계약 수준에서 강제되어야 합니다.

---

## 응답 데이터 모델 원칙

### 공통 Response Envelope

모든 응답은 최소한 아래 구조를 따릅니다.

- `request_id`: 추적 가능한 요청 식별자
- `data`: 안정 필드(핵심)
- `meta`: 실행 문맥(모드/시간축/버전 등)
- `warnings`: 제한/주의/비권장 사항(필요 시)
- `errors`: 표준 에러(실패 시)

---

### 문맥 메타(meta)의 최소 구성

`meta`에는 최소한 아래를 포함합니다.

- `spec_version`: 계약 버전
- `mode`: 현재/제안된 코칭 모드
- `time_axis`: 과거/현재/미래 중 하나
- `ui_hint`: UI가 과도하게 설명하지 않도록 돕는 최소 힌트

---

### UI Hint 설계 원칙

`ui_hint`는 UI를 지시하지 않습니다.  
UI의 판단을 대체하지 않습니다.

단지:
- 과거 카드/미래 씨앗 같은  
  **경로 인식 요소의 노출 우선순위** 정도만 제공합니다.

---

## 에러/실패 설계 원칙

### 1️⃣ 사용자의 기록은 절대 “사라지지 않게” 한다

- 저장 실패 시에도 로컬 임시 저장을 전제로 설계
- 서버는 `409/429/500` 등 실패를 표준 형태로 반환
- UI는 실패를 “사용자 탓”으로 표현하지 않음

---

### 2️⃣ AI 실패는 서비스 실패가 아니다

AI 응답 생성 실패는:
- 코칭 실패가 아니라
- 한 번의 도구 실패로 취급합니다.

이 경우 API는:
- 사용자 기록 저장은 성공 처리
- AI 응답은 빈 값 + 재시도 가능 상태 반환

---

## 프라이버시 및 비식별화 원칙(계약 관점)

OpenAPI 계약은:
- PII를 필드 구조에서부터 제한합니다.

최소 원칙:
- 사용자 실명, 전화번호, 주소, 생년월일 등은  
  **요청/응답 스키마에서 제거**한다
- 식별이 필요한 경우에도 `user_id`는 내부 식별자만 사용
- 로그 필드에 사용자 입력 원문을 그대로 남기지 않도록  
  마스킹 규칙을 별도 문서(`operations/`)에서 강제

---

## 구현 가이드(권장 흐름)

1. 이 문서의 원칙을 기준으로 OpenAPI YAML을 작성한다.
2. YAML로부터 타입을 생성하여 프론트/백이 공유한다.
3. API 응답의 `meta(mode/time_axis)`를 UI와 AI가 동시에 참조한다.
4. 계약 변경은 구현 변경보다 먼저, 문서로 합의한다.

---

## 한 문장 요약

> **이 시스템에서 OpenAPI는  
> 데이터를 나르는 배관이 아니라,  
> 사용자의 기록·자각·정리 흐름을 끊지 않겠다는 행동 계약이다.**
